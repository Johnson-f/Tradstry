# Tradistry Backend Codebase Documentation

This document provides a detailed breakdown of each file within the `tradistry_backend` project, explaining its purpose, key components, and role in the overall architecture.

---

## Root Directory

### `main.go`
- **Purpose**: The main entry point for the entire application.
- **Key Functions**:
    - **Configuration Loading**: Loads environment variables using the `config` package.
    - **Fiber Initialization**: Creates a new Fiber web server instance.
    - **Middleware Setup**: Configures essential middleware, including `logger` for request logging and `cors` for Cross-Origin Resource Sharing.
    - **Service Initialization**: Initializes the `DatabaseService` for Supabase connectivity and then injects it into the `SupabaseUserService` and `SupabaseTradeService`.
    - **Health Checks**: Performs a database health check on startup to ensure connectivity.
    - **Router Setup**: Initializes and configures the API routes from `UserRouter` and `TradeRouter`.
    - **Root Endpoints**: Defines basic endpoints like `/` for a welcome message and `/health` for a status check.
    - **Server Start**: Starts the Fiber application, listening for incoming HTTP requests on the configured port.

### `go.mod`
- **Purpose**: The Go modules file that defines the project's module path and its dependencies.
- **Key Dependencies**:
    - `github.com/gofiber/fiber/v2`: The web framework used for building the API.
    - `github.com/supabase-community/supabase-go`: The client library for interacting with Supabase.
    - `github.com/golang-jwt/jwt/v5`: Used for parsing and validating JWTs.

### `go.sum`
- **Purpose**: A generated file that contains the checksums of the direct and indirect dependencies. It ensures the integrity and reproducibility of the build.

### `tradistry-backend`
- **Purpose**: This is the compiled binary executable of the application, generated by the `go build` command. It is the file that is run to start the server.

---

## `/config`

### `config.go`
- **Purpose**: Manages all configuration for the application, loaded from environment variables.
- **Key Components**:
    - **`Config` struct**: A top-level struct that aggregates all other configuration structs (`ServerConfig`, `DatabaseConfig`, `SupabaseConfig`, `JWTConfig`).
    - **`Load()` function**: The main function that reads environment variables and populates the `Config` struct. It uses helper functions to provide default values if an environment variable is not set.
    - **Helper Functions**: `getEnv` and `getEnvAsInt` retrieve and parse environment variables with fallbacks.

---

## `/models`

### `user.go`
- **Purpose**: Defines the data structures related to users.
- **Key Structs**:
    - **`User`**: Represents the user entity in the database, with `db` tags for mapping to table columns.
    - **`UserCreateRequest`**: Defines the expected JSON payload for creating a new user, with validation tags.
    - **`UserResponse`**: Defines the JSON structure for user data sent back to the client, omitting sensitive information.

### `trade.go`
- **Purpose**: Defines the data structures related to trades.
- **Key Components**:
    - **`TradeType` & `TradeStatus`**: Enums that define the possible values for a trade's type (`buy`/`sell`) and status (`open`/`closed`).
    - **`Trade`**: Represents the trade entity in the database.
    - **`TradeCreateRequest` & `TradeUpdateRequest`**: Define the JSON payloads for creating and updating trades, with validation tags.

---

## `/routers`

### `user_router.go`
- **Purpose**: Defines and registers all API routes related to users.
- **Key Components**:
    - **`UserRouter` struct**: Holds a dependency on `UserServiceInterface`, decoupling it from a specific implementation.
    - **`SetupUserRoutes()`**: A method that groups routes under `/api/v1/users` and maps HTTP methods (`POST`, `GET`, `PUT`, `DELETE`) to the corresponding handler methods in the user service.

### `trade_router.go`
- **Purpose**: Defines and registers all API routes related to trades and analytics.
- **Key Components**:
    - **`TradeRouter` struct**: Holds a dependency on `TradeServiceInterface`.
    - **`SetupTradeRoutes()`**: Groups routes under `/api/v1/trades` and maps them to service handlers. This includes CRUD endpoints and analytics endpoints like `/analytics/summary`.

---

## `/services`

### `interfaces.go`
- **Purpose**: Defines the contracts (interfaces) for the application's services and repositories. This is key for dependency injection and allows for mocking in tests.
- **Key Interfaces**:
    - **`UserServiceInterface` & `TradeServiceInterface`**: Define the methods that the HTTP handlers in the routers will call.
    - **`UserRepositoryInterface` & `TradeRepositoryInterface`**: Define the methods for data access, abstracting the database logic.

### `database.go`
- **Purpose**: A generic service for interacting with the Supabase database.
- **Key Components**:
    - **`DatabaseService` struct**: Holds the initialized Supabase client.
    - **`NewDatabaseService()`**: A constructor that creates and returns a new `DatabaseService`.
    - **CRUD Wrappers**: Provides generic `Insert`, `Select`, `Update`, and `Delete` methods that wrap the Supabase client's functions for easier use in other services.
    - **`HealthCheck()`**: A function to verify that the database connection is alive.

### `auth_service.go`
- **Purpose**: Handles JWT-based authentication and validation.
- **Key Components**:
    - **`AuthService` struct**: Holds the Supabase client and application configuration.
    - **`SupabaseClaims`**: A custom struct to correctly parse the claims from a Supabase-issued JWT.
    - **`ValidateToken()`**: The core function that parses a JWT string, verifies its signing method and signature against the `JWT_SECRET`, checks for expiration, and extracts user information into an `AuthUser` struct.

### `supabase_user_service.go`
- **Purpose**: The Supabase-backed implementation of the `UserServiceInterface`. It handles all business logic for users.
- **Key Functions**:
    - **Repository-like Methods**: `CreateUser`, `GetUserByID`, `UpdateUser`, etc., which contain the logic to interact with the `DatabaseService` to perform operations on the `users` table.
    - **HTTP Handlers**: `CreateUserHandler`, `GetUserHandler`, etc., which are the functions directly called by the router. They handle parsing the request, calling the repository-like methods, and formatting the HTTP response.

### `supabase_trade_service.go`
- **Purpose**: The Supabase-backed implementation of the `TradeServiceInterface`. It handles all business logic for trades.
- **Key Functions**:
    - **Data Isolation**: All methods take a `userID` as a parameter to ensure users can only access or modify their own trades. The `getUserIDFromContext` helper retrieves this ID, which is placed there by the authentication middleware.
    - **Repository-like Methods**: `CreateTrade`, `GetTradeByID`, etc., for interacting with the `trades` table via the `DatabaseService`.
    - **HTTP Handlers**: `CreateTradeHandler`, `GetTradesHandler`, etc., for handling the full lifecycle of an API request.
    - **Analytics Placeholders**: Includes placeholder implementations for `GetTradingSummary` and `GetPerformanceMetrics`.

### `user_service.go` & `trade_service.go`
- **Purpose**: These appear to be older, mock implementations of the user and trade services. They do not connect to a database and return hardcoded, static data. They are likely kept for testing or historical purposes but are not used in the main application flow, which now uses the `supabase_*_service.go` files.

---

## `/middleware`

### `auth.go`
- **Purpose**: Provides authentication middleware for protecting API routes.
- **Key Functions**:
    - **`AuthMiddleware`**: An HTTP handler that:
        1. Extracts the token from the `Authorization: Bearer <token>` header.
        2. Validates the token using the `AuthService`.
        3. If valid, it injects the user's information (`ID`, `Email`, `Role`) into the request's local context (`c.Locals`).
        4. If invalid, it aborts the request with a `401 Unauthorized` error.
    - **`OptionalAuthMiddleware`**: A placeholder for middleware that might handle optional authentication.

### `validation.go`
- **Purpose**: Contains placeholder middleware for future implementation of request validation and rate limiting.

---

## `/utils`

### `response.go`
- **Purpose**: Provides centralized helper functions for creating consistent JSON responses.
- **Key Functions**:
    - **`SuccessResponse`**: Formats a standard success response.
    - **`ErrorResponse`**: Formats a standard error response with a given status code.
    - **`ValidationErrorResponse`**: Formats a detailed response for validation errors.
