version: '3.8'

# Docker Compose for Celery services using Redis Cloud
# Note: Redis service removed since we're using Redis Cloud

services:
  celery_worker:
    build: .
    container_name: tradistry_celery_worker
    command: celery -A scheduler.celery_app worker --loglevel=info --concurrency=4
    volumes:
      - .:/app
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; import os; redis.from_url(os.getenv('REDIS_URL')).ping()"]
      interval: 30s
      timeout: 10s
      retries: 3

  celery_beat:
    build: .
    container_name: tradistry_celery_beat
    command: celery -A scheduler.celery_app beat --loglevel=info
    volumes:
      - .:/app
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; import os; redis.from_url(os.getenv('REDIS_URL')).ping()"]
      interval: 30s
      timeout: 10s
      retries: 3

  flower:
    build: .
    container_name: tradistry_flower
    command: celery -A scheduler.celery_app flower --port=5555
    ports:
      - "5555:5555"
    volumes:
      - .:/app
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/api/workers"]
      interval: 30s
      timeout: 10s
      retries: 3

# No volumes needed since we're using Redis Cloud
